setkey(driver, ping_time, dummy) %>%
foverlaps(shiftd, type = "within",
mult = "all", nomatch = NULL) %>%
.[,.(start_time = mean(shift_start), end_time = mean(shift_end),
shift_length = mean(shift_length),
precip_intensity = mean(precip_intensity, na.rm = TRUE),
precip_probability = mean(precip_probability, na.rm = TRUE),
wind_speed = mean(wind_speed, na.rm = TRUE),
visibility = mean(visibility, na.rm = TRUE),
speed_limit = mean(speed_limit, na.rm = TRUE),
num_lanes = mean(num_lanes, na.rm = TRUE)),
.(driver, shift_ID)] %>%
merge(driver, by = "driver") %>%
setkey(driver, start_time, end_time) %>%
foverlaps(sce, by.x = c("driver", "start_time", "end_time"),
type = "any", mult = "all", nomatch = NA) %>%
.[,dummy:= NULL] %>%
setkey(driver, shift_ID)
shif = eve %>%
.[,.(n_SCE = sum(!is.na(event_time)),
SCE_time = paste(event_time, collapse = ";"),
SCE_type = paste(event_type, collapse = ";"),
start_time = mean(start_time), end_time = mean(end_time),
shift_length = mean(shift_length),
age = mean(age),
precip_intensity = mean(precip_intensity, na.rm = TRUE),
precip_probability = mean(precip_probability, na.rm = TRUE),
wind_speed = mean(wind_speed, na.rm = TRUE),
visibility = mean(visibility, na.rm = TRUE),
speed_limit = mean(speed_limit, na.rm = TRUE),
num_lanes = mean(num_lanes, na.rm = TRUE)),
.(driver, shift_ID)] %>%
setkey(driver, shift_ID)
fwrite(shif, "data/32-analyses_shifts.csv")
fwrite(eve, "data/33-analyses_eve.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[!is.na(event_time),.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
event_tab
event_tab
eve
event_tab = eve %>%
.[!is.na(event_time),.(driver, shift_ID, start_time, event_time, shift_length)]
event_tab
eve = data.table::fread("data/33-analyses_eve.csv")
eve[,.N, event_type]
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
driverlist = c("canj1",  "farj7",  "gres0",  "hunt",   "kell0")
shif = shif[driver %in% driverlist,]
event_tab = event_tab[driver %in% driverlist,]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,precip_intensity:precip_intensity]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,precip_intensity:precip_intensity])
)
library(rstan)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250)#, init_r = .5
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
driverlist = c("canj1",  "farj7",  "gres0",  "hunt",   "kell0", "lewr10", "rice30", "smiv")
shif = shif[driver %in% driverlist,]
event_tab = event_tab[driver %in% driverlist,]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,precip_intensity:precip_intensity]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,precip_intensity:precip_intensity])
)
library(rstan)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250)#, init_r = .5
shif[,unique(driver)]
driverlist = c("canj1",  "farj7",  "gres0",  "hunt",   "kell0", "lewr10", "rice30", "smiv")
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
driverlist = c("canj1",  "farj7",  "gres0",  "hunt",   "kell0", "lewr10", "rice30", "smiv")
shif = shif[driver %in% driverlist,]
event_tab = event_tab[driver %in% driverlist,]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,precip_intensity:precip_intensity]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,precip_intensity:precip_intensity])
)
library(rstan)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250)#, init_r = .5
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
driverlist = c("canj1",  "farj7",  "gres0",  "hunt",   "kell0", "lewr10")
shif = shif[driver %in% driverlist,]
event_tab = event_tab[driver %in% driverlist,]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,precip_intensity:precip_intensity]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,precip_intensity:precip_intensity])
)
library(rstan)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250)#, init_r = .5
shif[,unique(driver)]
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
driverlist = c("canj1",  "farj7",  "gres0",  "hunt",   "kell0", "rice30", "smiv")
shif = shif[driver %in% driverlist,]
event_tab = event_tab[driver %in% driverlist,]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,precip_intensity:precip_intensity]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,precip_intensity:precip_intensity])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250)#, init_r = .5
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
driverlist = c("canj1",  "farj7",  "gres0",  "hunt",   "kell0", "rice30", "smiv", "sunc", "woow59")
shif = shif[driver %in% driverlist,]
event_tab = event_tab[driver %in% driverlist,]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,precip_intensity:precip_intensity]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,precip_intensity:precip_intensity])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250)#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250, chains= 3)#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250, chain= 3)#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250, nchain= 3)#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat, refresh = 250, nchains= 3)#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 3, iter = 2000, data = standat, refresh = 250)#, init_r = .5
traceplot(fit)
traceplot(fit, "beta")
standat
shif
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,age:num_lanes]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,age:num_lanes])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 1000, data = standat, refresh = 250)#, init_r = .5
fit
p
shif[,unique(driver)]
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
shif[driver == "lewe10"]
shif[driver == "lewe10",]
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
shift[,.N,driver]
shif[,.N,driver]
shif[driver == "lewr10",]
View(shif[driver == "lewr10",])
shif[driver == "lewr10",SCE_time]
event_tab
shif
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
shif = shif[!(driver %in% "lewr10" & shift_ID == 10),]
event_tab = event_tab[!(driver %in% "lewr10" & shift_ID == 10),]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,age:num_lanes]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,age:num_lanes])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 1000, data = standat, refresh = 250)#, init_r = .5
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))/60] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
event_tab
tau = shif[,shift_length/60];
event_time = event_tab[,time2event/60]
tau
event_time
event_tab
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
tau = shif[,shift_length/60]
event_time = event_tab[,time2event/60]
tau
event_time
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
shif = shif[!(driver %in% "lewr10" & shift_ID == 10),]
event_tab = event_tab[!(driver %in% "lewr10" & shift_ID == 10),]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,age:num_lanes]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,age:num_lanes])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 1000, data = standat, refresh = 250)#, init_r = .5
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,age:num_lanes]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,age:num_lanes])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 1000, data = standat, refresh = 250)#, init_r = .5
shif[,n_SCE]
cumsum(shif[,n_SCE])
event_time
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
event_tab
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))] %>%
.[,time2event := ifelse(time2event == 0, 0.01, time2event)] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,age:num_lanes]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,age:num_lanes])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 1000, data = standat, refresh = 250)#, init_r = .5
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))] %>%
.[,time2event := ifelse(time2event == 0, 0.01, time2event)] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,age:num_lanes]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,age:num_lanes])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 4, iter = 2000, data = standat, refresh = 250)#, init_r = .5
traceplot(fit, "beta")
pacman::p_load(dplyr, ggplot2, rstan, data.table, lubridate)
shif = data.table::fread("data/32-analyses_shifts.csv")
eve = data.table::fread("data/33-analyses_eve.csv")
event_tab = eve %>%
.[event_type %in% c("HB", "HW", "CM", "RS"),
.(driver, shift_ID, start_time, event_time, shift_length)] %>%
.[,`:=`(start_time = ymd_hms(start_time), event_time = ymd_hms(event_time))] %>%
.[,time2event := as.integer(difftime(event_time, start_time, units = "mins"))] %>%
.[,time2event := ifelse(time2event == 0, 0.01, time2event)] %>%
.[,shift_id := as.integer(as.factor(paste0(driver, shift_ID)))]
shif[,unique(driver)]
standat = list(
N = shif[,sum(n_SCE)],
K = ncol(shif[,age:num_lanes]),
S = shif[,.N],
D = shif[,length(unique(driver))],
id = shif[,as.integer(as.factor(driver))],
tau = shif[,shift_length/60],
event_time = event_tab[,time2event/60],
group_size = shif[,n_SCE],
X_predictors = as.matrix(shif[,age:num_lanes])
)
fit = stan("stan/nhppnoevent_log.stan",
chains = 4, iter = 2000, data = standat,
control = list(adapt_delta = 0.99))#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat,
control = list(adapt_delta = 0.99),
max_treedepth = 15)#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 1, iter = 2000, data = standat,
control = list(adapt_delta = 0.99,
max_treedepth = 15))#, init_r = .5
fit = stan("stan/nhppnoevent_log.stan",
chains = 4, iter = 2000, data = standat,
control = list(adapt_delta = 0.99,
max_treedepth = 15))#, init_r = .5
traceplot(fit, "beta")
fit = stan("stan/nhppnoevent_log.stan",
chains = 3, iter = 2000, data = standat,
control = list(adapt_delta = 0.99,
max_treedepth = 15), seed = 123)#, init_r = .5
traceplot(fit, "beta")
saveRDS(fit, "fit/nhpp_fit.rds")
